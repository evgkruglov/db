# РепликаSet и Управление Подами в Kubernetes

## Зачем нужен ReplicaSet
ReplicaSet — это контроллер в Kubernetes, который гарантирует, что заданное количество экземпляров подов (реплик) всегда запущено в кластере. Он автоматически создает, удаляет и пересоздаёт поды по мере необходимости, чтобы поддерживать желаемое состояние.

ReplicaSet не работает с произвольно созданными подами — только с теми, которые созданы им самим на основе заданного шаблона. Если под выходит из строя или узел, на котором он запущен, становится недоступным, ReplicaSet создаёт новую реплику на другом узле.

## Основные характеристики ReplicaSet
- **Гарантированное количество подов** — следит, чтобы всегда было нужное число.
- **Работа по селекторам меток** — находит поды, которыми должен управлять.
- **Три ключевых элемента:**
  - Селектор меток
  - Количество реплик
  - Шаблон пода
- **Совместим с горизонтальным масштабированием** (вручную и автоматически)
- **Хорошая практика** — не указывать селектор меток явно: он будет автоматически создан на основе меток шаблона пода.

## Важные особенности
- **Изменение шаблона не влияет** на уже созданные поды. Чтобы применить изменения, нужно удалить старые поды, ReplicaSet создаст новые по новому шаблону.
- **Удаление пода вручную** приводит к его воссозданию — полезно для отладки или экспериментов.
- **Можно редактировать** ReplicaSet на лету: `kubectl edit rs <имя>`.
- ReplicaSet заменил устаревший **ReplicationController**, добавив гибкость работы с метками.

## Зависимость от kubelet и контрольной плоскости
- Kubelet запускает контейнеры на узле и следит за их жизнеспособностью.
- Если узел падает — **контрольная плоскость** определяет потерю и ReplicaSet восстанавливает нужное число реплик на других узлах.

## Проверка живости (LivenessProbe)
Позволяет определить, нужно ли перезапустить контейнер. Настраивается в манифесте пода.

### Виды LivenessProbes:
1. **HTTP GET** — успешен, если код ответа 2xx или 3xx
2. **TCP Socket** — проверка доступности порта
3. **Exec** — команда в контейнере должна возвращать код 0

> Не рекомендуется использовать exec с приложениями на JVM (Java), так как это запускает дополнительную JVM и может исказить результат.

> Все проверки выполняет kubelet. Контрольная плоскость участия не принимает, если речь не идёт о падении узла.

## DaemonSet
Позволяет запускать один экземпляр пода **на каждом узле** кластера (или подмножестве узлов). Пример — агенты сбора логов, мониторинга, kube-proxy.

- Не использует стандартный планировщик, т.к. уже знает, на каких узлах запускаться.
- Не пересоздает под на другом узле при падении текущего.
- Создает новые поды на **новых** узлах автоматически.
- **Unschedulable** узлы игнорируются (хотя планировщик обходит DaemonSet, это ограничение всё равно применяется).

## Job
Job — ресурс, запускающий под, который **завершается**, как только контейнер успешно выполнит команду.

- Под не перезапускается, если завершился с кодом 0
- Полезен для одноразовых или периодических задач (миграции, бэкапы и т.д.)
- Можно задать:
  - **completions** — сколько подов должно успешно завершиться
  - **parallelism** — сколько одновременно

## CronJob
Аналог cron-заданий в Linux:
- Выполняет Job по расписанию
- Может допустить:
  - Одновременное выполнение нескольких Job (поэтому Job должен быть идемпотентным)
  - Пропуск запуска (следующая Job должна компенсировать работу предыдущей)

---

## Краткий итог
- **ReplicaSet** нужен для гарантии постоянного количества реплик подов.
- Используйте **livenessProbe** для перезапуска зависших приложений.
- **DaemonSet** — когда под должен быть на каждом узле.
- **Job и CronJob** — для одноразовых и периодических задач.

> Всегда стоит использовать ReplicaSet или Deployment, а не напрямую создавать поды — это обеспечит отказоустойчивость и масштабируемость.
